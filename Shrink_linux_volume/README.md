
Уменьшаем размер диска в vmware

Дано: виртуальная машина с 1 диском в 100gb, внутри 1 корневой раздел без lvm. Хотим получить диск 50Gb

Акт 1: уменьшение раздела.
один из простых вариантов - выключить виртуалку, через веб интерфейс добавить этот диск к любой другой виртуалке и там уже проводить действия. Пускай присоединенный диск будет sdb, а раздел sdb1.

1. проверим целостность раздела который хотим уменьшить
```
e2fsck -f /dev/sdb1
```
2. уменьшим размер файловой системы до 50Gb
```
resize2fs /dev/sdb1 50G
```
3. Изменяем размер раздела.
```
fdisk /dev/sdb
```
вывод текущей схемы будет таким:
```
Disk /dev/sdb: 100 GiB, 107374182400 bytes, 209715200 sectors
Device     Bootс       End   Sectors  Size Id Type
/dev/sdb1  *     2048 209713151 209711104  100G 83 Linux
```
удаляем раздел и создаем его заново: 
```
- d (delete)
- n (new)
- p (primary)
- 1 (Partition number)
- 2048 (берем это число из колонки  Start в выводе сверху - это начало нашего раздела и его нужно сохранить)
- 104857599 (про это число подробнее ниже). Ни в коем случае не пишем здесь +50G. т.к. размер нашего раздела на самом деле меньше.
- если нас спросят про то хотим ли мы удалить метку ext4, отвечаем отрицательно.
```
итак, а что это за волшебное число 104857599 и как его получить. Это номер последнего сектора на котором заканчивается наш раздел. 
Тут вот самый взрыв мозга у юного поколения. По задаче нам нужно получить диск размером 50Gb. 
Это значит в это число нужно уложить раздел и еще загрузчик (ну и может быть еще другие разделы). 
Под загрузчик отводится 0-2048 блоков. а блок занимает (в моем случае) 512 байт. 
Вот и выходит что последний блок это не просто +50гб от какого-то там 2048. т.о. рождается формула подсчета последнего блока:
```
(X*1024*1024*1024)/Y-1
где х - число гигабайт, Y - размер блока

(50*1024*1024*1024)/512-1 = 104857599
это - наш конец диска. -1 здесь нужно потому что счет границ включительно. это как с подсчетом отпуска - со 2 по 9 это не неделя, а 8 дней на самом деле. 
А надо 7. поэтому вычитаем единичку.
```
посмотрим что получилось с помощью команды p:
```
Disk /dev/sdb: 100 GiB, 107374182400 bytes, 209715200 sectors
Device     Boot Start       End   Sectors Size Id Type
/dev/sdb1        2048 104857599 104855552  50G 83 Linux
```
Теперь мы видим что наш раздел 50Gb, диск по-прежнему 100gb, но тут мы уже повлиять не можем, править размер диска нужно в другом месте. 
Соглашаемся все записать с помощью команды w и выходим из fdisk.

4. Восстанавливаем размер фс и проверяем на целостность того что получилось.
```
resize2fs /dev/sdb1
e2fsck -f /dev/sdb1
```
Акт 2:
Переходим снова в интерфейс вцентра и отсоединяем диск от виртуалки в которой работали и от виртуалки-родителя - просто удаляем из hardware полностью диск
(ну не удаляя его с хранилища естественно). 
Говорить про политику решений в ынтырпрайзе можно много, и этот случай яркое тому доказательство. 
Нельзя просто так взять и через интерфейс уменьшить размер диска. 
Поэтому что? конечно же консоль. Логинимся по ssh на сервер который имеет доступ к хранилищу где лежит наш диск. 

1. Открываем файл
```
vi <vm-name>.vmdk
```
ищем строчку
```
RW 209715200 VMFS "<vm-name>.vmdk"
```
и меняем число на количество блоков нашего диска. 
Диск у нас был 100, должен стать 50, поэтому здесь можно просто разделить число пополам: 209715200/2 или пойти по пути вычислений - взять наш последний блок и прибавить один: 
104857599+1 или полностью: (50*1024*1024*1024)/512 = 104857600.

2. Остался последний штрих, диск нужно уменьшить в размере физически с помощью конвертирования:
мы копируем диск при этом новый файл получит реальный размер в 50Gb а не в 100Gb, и в данном случае прогресс остановится на 50% т.к. сократили в 2 раза.
```
vmkfstools -i <vm-name>.vmdk -d thin shrunk-<vm-name>.vmdk  
```
Подменяем старый диск на новый
```
vmkfstools -E <vm-name>.vmdk original-<vm-name>.vmdk
vmkfstools -E shrunk-<vm-name>.vmdk <vm-name>.vmdk
```
3. Подцепляем обратно к виртуалке новый диск (со старым именем) и запускаем vm

Теперь у нас со стороны vmware действительно будет диск размером 50Gb в тонкой провизии, а внутри вм будет раздел ~50Gb.
